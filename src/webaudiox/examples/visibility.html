<!doctype html>
<body><script>


	// Fix up prefixing
	window.AudioContext = window.AudioContext || window.webkitAudioContext;
	// init context
	var context	= new AudioContext()

	var mainOut	= (function(){
		//return context.destination

		var gainNode	= context.createGain()
		gainNode.connect(context.destination)
		
		muteWithVisibility(gainNode)
		
		return gainNode	
	})()
	
//////////////////////////////////////////////////////////////////////////////////
//		pageVisibility							//
//////////////////////////////////////////////////////////////////////////////////

	// init each sound
	loadBuffer('sounds/eatpill.mp3', function(buffer){
		var source	= context.createBufferSource();
		source.buffer	= buffer;
		source.connect(mainOut);
		source.loop	= true;
		source.start(0);
	})


	//////////////////////////////////////////////////////////////////////////////////
	//		comment								//
	//////////////////////////////////////////////////////////////////////////////////
	
	function loadBuffer(url, onLoad, onError){
		var request	= new XMLHttpRequest()
		request.open('GET', url, true)
		request.responseType	= 'arraybuffer'
		request.onload	= function(){
			context.decodeAudioData(request.response, function(buffer){
				onLoad && onLoad(buffer)
			}, function(){
				onError && onError()
			})
		}
		request.send()
	}	


	//////////////////////////////////////////////////////////////////////////////////
	//		comment								//
	//////////////////////////////////////////////////////////////////////////////////
	
	function muteWithVisibility(gainNode){
		// shim to handle browser vendor
		var eventStr	= (document.hidden !== undefined	? 'visibilitychange'	:
			(document.mozHidden	!== undefined		? 'mozvisibilitychange'	:
			(document.msHidden	!== undefined		? 'msvisibilitychange'	:
			(document.webkitHidden	!== undefined		? 'webkitvisibilitychange' :
			console.assert(false, "Page Visibility API unsupported")
		))));
		var documentStr	= (document.hidden !== undefined ? 'hidden' :
			(document.mozHidden	!== undefined ? 'mozHidden' :
			(document.msHidden	!== undefined ? 'msHidden' :
			(document.webkitHidden	!== undefined ? 'webkitHidden' :
			console.assert(false, "Page Visibility API unsupported")
		))));
		// event handler for visibilitychange event
		var callback	= function(){
			var isHidden	= document[documentStr] ? true : false
			gainNode.gain.value	= isHidden ? 0 : 1
		}.bind(this)
		// bind the event itself
		document.addEventListener(eventStr, callback, false)
		// destructor
		this.destroy	= function(){
			document.removeEventListener(eventStr, callback, false)
		}
	}
</script></body>