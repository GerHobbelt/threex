<!DOCTYPE html>
<!-- include three.js stuff -->
<script src='../../../vendor/three.js/build/three.min.js'></script>
<script src='../../../vendor/three.js/examples/js/modifiers/SubdivisionModifier.js'></script>
<!-- include require.js stuff -->
<script src="../../../vendor/require.js/require.js"></script>
<!-- include threex.cannonjs -->
<script src='../../threex.cannonjs/vendor/cannon.js/build/cannon.min.js'></script>
<script src='../../threex.cannonjs/threex.cannonworld.js'></script>
<script src='../../threex.cannonjs/threex.cannonbody.js'></script>
<!-- include threex.keyboardstate -->
<script src="../../threex.keyboardstate/threex.keyboardstate.js"></script>
<!-- include threex.windowresize -->
<script src="../../threex.windowresize/threex.windowresize.js"></script>
<!-- include for threex.glowdatgui -->
<script src='../../../vendor/three.js/examples/js/libs/dat.gui.min.js'></script>
<script src="../../threex.glow/threex.glowdatgui.js"></script>
<!-- include for threex.mirrorball -->
<script src='../../threex.mirrorball/threex.mirrorball.js'></script>


<script src='vendor/microcache.js'></script>
<script src='vendor/microevent.js'></script>

<!-- include for threex.mirrorball -->
<script src='vendor/webaudiox/build/webaudiox.js'></script>
<!-- include the .js files for jsfx.js -->
<script src="vendor/webaudiox/examples/vendor/jsfx/audio.js"></script>
<script src="vendor/webaudiox/examples/vendor/jsfx/jsfx.js"></script>
<script src="vendor/webaudiox/examples/vendor/jsfx/jsfxlib.js"></script>

<script src='js/initlighting.js'></script>
<script src='js/gametimer.js'></script>
<script src='js/impactballemitter.js'></script>
<script src='js/initsounds.js'></script>
<script src='js/player.js'></script>
<script src='js/playercontrols.js'></script>
<script src='js/map.js'></script>

<body style='margin: 0px; background-color: #bbbbbb; overflow: hidden;'>

<body><style>
#timer {
	position	: absolute;
	top		: 0px;
	right		: 0;
	z-index		: 1;

	font-family	: arial, verdana, sans-serif;
	font-size	: 300%;
	font-weight	: bolder;

	color		: #000;
	text-shadow	: 0 0 0.2em #fbc, 0 0 0.2em #fbc, 0 0 0.2em #fbc;

	padding-left	: 10px;
	padding-right	: 10px;
}
</style>
<div id="timer">Ready ?</div>
<script>
require([ '../../threex.glow/package.require.js'
	, '../../threex.skymap/package.require.js'
], function(){
	var renderer	= new THREE.WebGLRenderer();
	renderer.setSize( window.innerWidth, window.innerHeight );
	document.body.appendChild( renderer.domElement );

	var updateFcts	= [];
	var scene	= new THREE.Scene();
	var camera	= new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.01, 100 );
	camera.position.x = 0
	camera.position.y = 5
	camera.position.z = 6;
	camera.lookAt( scene.position )

	var physicsWorld= new THREEx.CannonWorld().start()

	// setup winResize
	var winResize	= new THREEx.WindowResize(renderer, camera)

	// init keyboard		
	var keyboard	= new THREEx.KeyboardState(renderer.domElement);
	window.keyboard	= keyboard
	renderer.domElement.setAttribute("tabIndex", "0");
	renderer.domElement.focus();



	window.scene	= scene
	window.camera	= camera
	window.physicsWorld	= physicsWorld

	window.cache	= new Microcache()
	window.yeller	= MicroeventMixin({});
	window.GAME	= {}

	GAME.tileW	= 0.2
	var tileW	= GAME.tileW;
	
	// upadte sounds
	window.sounds	= initSounds();
	updateFcts.push(function(delta, now){
		sounds.update(delta. now)
	})

	// init lighting
	initLighting(renderer, scene)
	

	// add a skymap	
	var mesh	= THREEx.createSkymap('skybox')
	scene.add( mesh );

	// add gameTimer
	var gameTimer	= new GameTimer()
	updateFcts.push(function(delta, now){
		gameTimer.update(delta. now)
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		ball								//
	//////////////////////////////////////////////////////////////////////////////////
	var player	= new Player();
	var ball	= player.mesh;
	updateFcts.push(function(delta, now){
		player.update(delta, now)
	})

	yeller.addEventListener('spawnPlayer', function(){
		console.log('spawnPlayer')

		gameTimer.timerBegin	= Date.now()
		gameTimer.timerEnd	= null

		playerControls.disable	= false

		sounds.playSpawn();

		var body	= ball.userData.cannonBody.origin
		body.position.set(+22*tileW, 2, -13*tileW)
		body.velocity.set(0,0,0)
		body.angularVelocity.set(0,0,0)
	})
			
	yeller.addEventListener('killPlayer', function(){
		console.log('killPlayer')
		sounds.playDie()
		gameTimer.timerEnd	= Date.now();

		var body	= ball.userData.cannonBody.origin
		body.velocity.set(0,0,0)
		body.angularVelocity.set(0,0,0)

		var worldPoint	= new CANNON.Vec3(ball.position.x, ball.position.y, ball.position.z)
		var impulse	= new CANNON.Vec3(0,1.1,0)
		body.applyImpulse(impulse, worldPoint);

		playerControls.disable	= true
		setTimeout(function(){
			yeller.dispatchEvent('spawnPlayer')
		}, 0.8*1000)
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		camera controls							//
	//////////////////////////////////////////////////////////////////////////////////
			
	THREEx.TrackerControls	= function(tracked, source, target){
		var sourcePos	= null
		var targetPos	= null

		var _vector3	= new THREE.Vector3()
		this.update	= function(delta, now){
			// compute world position for source
			source.updateMatrixWorld();
			_vector3.getPositionFromMatrix( source.matrixWorld )
			sourcePos	= sourcePos || _vector3.clone()				
			sourcePos.lerp(_vector3, 0.05)
			tracked.position.copy(sourcePos)
			
			// compute world position for target
			target.updateMatrixWorld();
			_vector3.getPositionFromMatrix( target.matrixWorld )
			targetPos	= targetPos || _vector3.clone()				
			targetPos.lerp(_vector3, 0.05)

			// make tracked to fit those contrainst
			tracked.lookAt(targetPos)			
		}
	}

	var cameraHolder	= new THREE.Object3D
	scene.add(cameraHolder)

	var deltaCamera		= new THREE.Vector3(0,3,5)
	updateFcts.push(function(delta, now){
		cameraHolder.position.copy(ball.position)
		cameraHolder.position.add(deltaCamera)
	})
	
	var controls	= new THREEx.TrackerControls(camera, cameraHolder, ball)
	updateFcts.push(function(delta, now){
		controls.update(delta, now)
	})
	
	var deltaCameras	= [
		new THREE.Vector3(0,1,1),
		new THREE.Vector3(1,1,1),
		new THREE.Vector3(0,3,5),
		new THREE.Vector3(-1,1,-1),
	];
	// jump on space
	keyboard.domElement.addEventListener('keydown', function(event){
		var cameraIdx	= deltaCameras.indexOf(deltaCamera)
		if( cameraIdx === -1 ){
			deltaCamera	= deltaCameras[0]
		}else if( keyboard.eventMatches(event, '2') ){
			cameraIdx	= (cameraIdx+1)%deltaCameras.length
			deltaCamera	= deltaCameras[cameraIdx]
		}else if( keyboard.eventMatches(event, '1') ){
			cameraIdx	= (cameraIdx-1+deltaCameras.length)%deltaCameras.length
			deltaCamera	= deltaCameras[cameraIdx]
		}
	})
	
	
	//////////////////////////////////////////////////////////////////////////
	//		User Controls						//
	//////////////////////////////////////////////////////////////////////////
	
	var playerControls	= new PlayerControls(ball)
	updateFcts.push(function(delta, now){
		playerControls.update(delta, now)
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		comment								//
	//////////////////////////////////////////////////////////////////////////////////


	var map		= new Map()
	var table	= map.object3d
	scene.add(map.object3d)
	updateFcts.push(function(delta, now){
		map.update(delta, now);		
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		render the scene						//
	//////////////////////////////////////////////////////////////////////////////////
	updateFcts.push(function(){
		renderer.render( scene, camera );		
	})

	//////////////////////////////////////////////////////////////////////////////////
	//		loop runner							//
	//////////////////////////////////////////////////////////////////////////////////
	var lastTimeMsec= null
	requestAnimationFrame(function animate(nowMsec){
		// keep looping
		requestAnimationFrame( animate );
		// measure time
		lastTimeMsec	= lastTimeMsec || nowMsec-1000/60
		var deltaMsec	= Math.min(200, nowMsec - lastTimeMsec)
		lastTimeMsec	= nowMsec
		// call each update function
		updateFcts.forEach(function(updateFn){
			updateFn(deltaMsec/1000, nowMsec/1000)
		})
	})
})
</script></body>
